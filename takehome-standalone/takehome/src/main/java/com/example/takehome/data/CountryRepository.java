package com.example.takehome.data;

import java.io.IOException;
import java.util.HashMap;

import javax.annotation.PostConstruct;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.stereotype.Component;

import com.example.takehome.util.TakeHomeUtility;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.extern.slf4j.Slf4j;


@Slf4j
@Component
public class CountryRepository {
	
	@Value("${takehome.countryDataFilePath}")
	private String countryDataFilePath;
	
	//private static final String COUNTRY_DATA = "{ \"countries\": [ { \"code\": \"AD\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"AE\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"AF\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"AG\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"AI\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"AL\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"AM\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"AO\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"AQ\", \"continent\": { \"code\": \"AN\" } }, { \"code\": \"AR\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"AS\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"AT\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"AU\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"AW\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"AX\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"AZ\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"BA\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"BB\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"BD\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"BE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"BF\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"BG\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"BH\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"BI\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"BJ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"BL\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"BM\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"BN\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"BO\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"BQ\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"BR\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"BS\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"BT\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"BV\", \"continent\": { \"code\": \"AN\" } }, { \"code\": \"BW\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"BY\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"BZ\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"CA\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"CC\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"CD\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CF\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CH\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"CI\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CK\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"CL\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"CM\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CN\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"CO\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"CR\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"CU\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"CV\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"CW\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"CX\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"CY\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"CZ\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"DE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"DJ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"DK\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"DM\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"DO\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"DZ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"EC\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"EE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"EG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"EH\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ER\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ES\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"ET\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"FI\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"FJ\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"FK\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"FM\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"FO\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"FR\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"GA\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GB\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"GD\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"GE\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"GF\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"GG\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"GH\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GI\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"GL\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"GM\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GN\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GP\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"GQ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GR\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"GS\", \"continent\": { \"code\": \"AN\" } }, { \"code\": \"GT\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"GU\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"GW\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"GY\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"HK\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"HM\", \"continent\": { \"code\": \"AN\" } }, { \"code\": \"HN\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"HR\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"HT\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"HU\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"ID\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"IL\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IM\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"IN\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IO\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IQ\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IR\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"IS\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"IT\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"JE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"JM\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"JO\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"JP\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KE\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"KG\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KH\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KI\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"KM\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"KN\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"KP\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KR\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KW\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"KY\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"KZ\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"LA\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"LB\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"LC\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"LI\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"LK\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"LR\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"LS\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"LT\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"LU\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"LV\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"LY\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MA\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MC\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"MD\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"ME\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"MF\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"MG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MH\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"MK\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"ML\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MM\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"MN\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"MO\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"MP\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"MQ\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"MR\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MS\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"MT\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"MU\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MV\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"MW\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"MX\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"MY\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"MZ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"NA\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"NC\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"NE\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"NF\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"NG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"NI\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"NL\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"NO\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"NP\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"NR\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"NU\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"NZ\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"OM\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"PA\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"PE\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"PF\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"PG\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"PH\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"PK\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"PL\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"PM\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"PN\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"PR\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"PS\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"PT\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"PW\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"PY\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"QA\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"RE\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"RO\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"RS\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"RU\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"RW\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SA\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"SB\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"SC\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SD\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SE\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"SG\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"SH\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SI\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"SJ\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"SK\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"SL\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SM\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"SN\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SO\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SR\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"SS\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ST\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"SV\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"SX\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"SY\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"SZ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"TC\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"TD\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"TF\", \"continent\": { \"code\": \"AN\" } }, { \"code\": \"TG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"TH\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"TJ\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"TK\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"TL\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"TM\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"TN\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"TO\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"TR\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"TT\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"TV\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"TW\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"TZ\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"UA\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"UG\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"UM\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"US\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"UY\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"UZ\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"VA\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"VC\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"VE\", \"continent\": { \"code\": \"SA\" } }, { \"code\": \"VG\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"VI\", \"continent\": { \"code\": \"NA\" } }, { \"code\": \"VN\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"VU\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"WF\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"WS\", \"continent\": { \"code\": \"OC\" } }, { \"code\": \"XK\", \"continent\": { \"code\": \"EU\" } }, { \"code\": \"YE\", \"continent\": { \"code\": \"AS\" } }, { \"code\": \"YT\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ZA\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ZM\", \"continent\": { \"code\": \"AF\" } }, { \"code\": \"ZW\", \"continent\": { \"code\": \"AF\" } } ] }";
	private static final HashMap<String, String> countries = new HashMap<String, String>();
	
	@Autowired
	private ResourceLoader resourceLoader;
	
	@PostConstruct
	public void loadData() throws IOException {
		log.info("Load country data");
		ObjectMapper objectMapper = TakeHomeUtility.getObjectmapper();
		Resource resource = resourceLoader.getResource(countryDataFilePath);
		String countryData = TakeHomeUtility.readFileAsString(resource.getInputStream());
		
		JsonNode jsonNode = objectMapper.readTree(countryData);
		JsonNode contriesNode = jsonNode.get("countries");
		for (JsonNode objNode : contriesNode) {
			countries.put(objNode.get("code").asText(), objNode.get("continent").get("code").asText());
	    }
	}
	
	public String getCountryContinentCode(String countryCode) {
		return countries.get(countryCode);
	}
	
	/*
	public void queryCountryContinents(List<String> countryCodes) {
		//String codesCommaSeparated = String.join(",", countryCodes);
		String codesCommaSeparated = countryCodes.stream() .map(s -> "\"" + s + "\"") .collect(Collectors.joining(", "));
		
		String query = "{\r\n"
				+ "  countries(filter: {code: {in:[" + codesCommaSeparated + "]}}) {\r\n"
				+ " 		continent{\r\n"
				+ "      code\r\n"
				+ "      name\r\n"
				+ "      countries { code }\r\n"
				+ "    }\r\n"
				+ "  }\r\n"
				+ "}";
		log.info("Query: " + query);
		
		WebClient client = WebClient.create("https://countries.trevorblades.com");
		CountryContinentQueryResponse[] list = client.post()
			.uri("graphql")
			.body(Mono.just(query), String.class).retrieve().bodyToFlux(CountryContinentQueryResponse[].class).blockFirst();
		
		log.info("Query Response size: " + list.length);
	}
	*/
}
